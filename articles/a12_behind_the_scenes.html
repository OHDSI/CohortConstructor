<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Behind the scenes • CohortConstructor</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Behind the scenes">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">CohortConstructor</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a00_introduction.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/a01_building_base_cohorts.html">Building base cohorts</a></li>
    <li><a class="dropdown-item" href="../articles/a02_cohort_table_requirements.html">Applying cohort table requirements</a></li>
    <li><a class="dropdown-item" href="../articles/a03_require_demographics.html">Applying demographic requirements to a cohort</a></li>
    <li><a class="dropdown-item" href="../articles/a04_require_intersections.html">Applying requirements related to other cohorts, concept sets, or tables</a></li>
    <li><a class="dropdown-item" href="../articles/a05_update_cohort_start_end.html">Updating cohort start and end dates</a></li>
    <li><a class="dropdown-item" href="../articles/a06_concatanate_cohorts.html">Concatenating cohort records</a></li>
    <li><a class="dropdown-item" href="../articles/a07_filter_cohorts.html">Filtering cohorts</a></li>
    <li><a class="dropdown-item" href="../articles/a08_split_cohorts.html">Splitting cohorts</a></li>
    <li><a class="dropdown-item" href="../articles/a09_combine_cohorts.html">Combining Cohorts</a></li>
    <li><a class="dropdown-item" href="../articles/a10_match_cohorts.html">Generating a matched cohort</a></li>
    <li><a class="dropdown-item" href="../articles/a11_benchmark.html">CohortConstructor benchmarking results</a></li>
    <li><a class="dropdown-item" href="../articles/a12_behind_the_scenes.html">Behind the scenes</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/OHDSI/CohortConstructor/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Behind the scenes</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/CohortConstructor/blob/main/vignettes/a12_behind_the_scenes.Rmd" class="external-link"><code>vignettes/a12_behind_the_scenes.Rmd</code></a></small>
      <div class="d-none name"><code>a12_behind_the_scenes.Rmd</code></div>
    </div>

    
    
<p>In previous vignettes we have seen numerous R functions that can help
us to add a cohort of interest to a cdm reference. When our cdm
reference is to tables in a database, as is often the code, our R code
will have been translated to SQL that is run against tables in the
databases (for more details on how this is all implemented see <a href="https://oxford-pharmacoepi.github.io/Tidy-R-programming-with-OMOP/" class="external-link uri">https://oxford-pharmacoepi.github.io/Tidy-R-programming-with-OMOP/</a>).</p>
<p>Let’s again work with Eunomia and get the codes needed to create a
set of drug cohorts.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://darwin-eu.github.io/CDMConnector/" class="external-link">CDMConnector</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://darwin-eu.github.io/CodelistGenerator/" class="external-link">CodelistGenerator</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://darwin-eu.github.io/PatientProfiles/" class="external-link">PatientProfiles</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/CohortConstructor/">CohortConstructor</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                      dbdir <span class="op">=</span> <span class="fu"><a href="https://darwin-eu.github.io/CDMConnector/reference/eunomiaDir.html" class="external-link">eunomiaDir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://darwin-eu.github.io/CDMConnector/reference/cdmFromCon.html" class="external-link">cdmFromCon</a></span><span class="op">(</span><span class="va">con</span>, cdmSchema <span class="op">=</span> <span class="st">"main"</span>, writeSchema <span class="op">=</span> <span class="st">"main"</span>, </span>
<span>                  writePrefix <span class="op">=</span> <span class="st">"my_study_"</span><span class="op">)</span></span>
<span><span class="va">drug_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://darwin-eu.github.io/CodelistGenerator/reference/getDrugIngredientCodes.html" class="external-link">getDrugIngredientCodes</a></span><span class="op">(</span><span class="va">cdm</span>, </span>
<span>                                     name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"acetaminophen"</span>,</span>
<span>                                              <span class="st">"amoxicillin"</span>, </span>
<span>                                              <span class="st">"diclofenac"</span>, </span>
<span>                                              <span class="st">"simvastatin"</span>,</span>
<span>                                              <span class="st">"warfarin"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>To capture all the SQL executed as we use CohortConstructor functions
we can set a global option. For this, we just need to point to a
directory in which we’ll save each SQL statement run behind the scenes.
Note that in this example we’re using duckdb so the SQL is for this
database management system. If you were running on a different type of
database the SQL would be adapted accordingly.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dir_sql</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"sql_folder"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir_sql</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">"omopgenerics.log_sql_path"</span> <span class="op">=</span> <span class="va">dir_sql</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">drugs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/conceptCohort.html">conceptCohort</a></span><span class="op">(</span><span class="va">cdm</span>, </span>
<span>                           conceptSet <span class="op">=</span> <span class="va">drug_codes</span>,</span>
<span>                           exit <span class="op">=</span> <span class="st">"event_end_date"</span>,</span>
<span>                           name <span class="op">=</span> <span class="st">"drugs"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># print sql in order they were saved</span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.info</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">dir_sql</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sorted_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">files</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">files</span><span class="op">$</span><span class="va">ctime</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">sorted_files</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"### "</span>, <span class="va">sorted_files</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"\n\n"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sql_with_quotes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'"'</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">sorted_files</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">'\n'</span><span class="op">)</span>, <span class="st">'"'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">sql_with_quotes</span>, <span class="st">"\n```\n\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; ### /tmp/RtmpdAnnWU/sql_folder/CohortConstructor_uploadCohortCodelistlogged_query_ran_on_2025_04_09_at_10_25_49.sql</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; "&lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id,</span></span>
<span><span class="co">#&gt;   CAST(concept_id AS INTEGER)<span style="color: #0000BB;"> AS </span>concept_id,</span></span>
<span><span class="co">#&gt;   LOWER(domain_id)<span style="color: #0000BB;"> AS </span>domain_id</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span> my_study_tmp_001_og_004_1744194350.*, domain_id</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> my_study_tmp_001_og_004_1744194350</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">LEFT JOIN</span> concept</span></span>
<span><span class="co">#&gt;     <span style="color: #0000BB;">ON</span> (my_study_tmp_001_og_004_1744194350.concept_id = concept.concept_id)</span></span>
<span><span class="co">#&gt; ) q01" </span></span>
<span><span class="co">#&gt; ```</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ### /tmp/RtmpdAnnWU/sql_folder/CohortConstructor_tempCohort_logged_query_ran_on_2025_04_09_at_10_25_49.sql</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; "&lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span></span></span>
<span><span class="co">#&gt;   person_id<span style="color: #0000BB;"> AS </span>subject_id,</span></span>
<span><span class="co">#&gt;   drug_concept_id<span style="color: #0000BB;"> AS </span>concept_id,</span></span>
<span><span class="co">#&gt;   drug_exposure_start_date<span style="color: #0000BB;"> AS </span>cohort_start_date,</span></span>
<span><span class="co">#&gt;   drug_exposure_end_date<span style="color: #0000BB;"> AS </span>cohort_end_date,</span></span>
<span><span class="co">#&gt;   cohort_definition_id</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> drug_exposure</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">INNER JOIN</span> (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span> concept_id, cohort_definition_id</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> my_study_tmp_001_og_004_1744194350</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">WHERE</span> (domain_id IN ('drug'))</span></span>
<span><span class="co">#&gt; ) RHS</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">ON</span> (drug_exposure.drug_concept_id = RHS.concept_id)" </span></span>
<span><span class="co">#&gt; ```</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ### /tmp/RtmpdAnnWU/sql_folder/CohortConstructor_conceptCohort_reduce_logged_query_ran_on_2025_04_09_at_10_25_50.sql</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; "&lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id,</span></span>
<span><span class="co">#&gt;   subject_id,</span></span>
<span><span class="co">#&gt;   cohort_start_date,</span></span>
<span><span class="co">#&gt;   COALESCE(cohort_end_date, cohort_start_date)<span style="color: #0000BB;"> AS </span>cohort_end_date</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> my_study_og_005_1744194350_1" </span></span>
<span><span class="co">#&gt; ```</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ### /tmp/RtmpdAnnWU/sql_folder/CohortConstructor_fulfillCohortReqs_filterStartEnd_logged_query_ran_on_2025_04_09_at_10_25_50.sql</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; "&lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> my_study_drugs.*</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> my_study_drugs</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">WHERE</span></span></span>
<span><span class="co">#&gt;   (NOT((cohort_start_date IS NULL)))<span style="color: #0000BB;"> AND</span></span></span>
<span><span class="co">#&gt;   (cohort_start_date &lt;= cohort_end_date)" </span></span>
<span><span class="co">#&gt; ```</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ### /tmp/RtmpdAnnWU/sql_folder/CohortConstructor_fulfillCohortReqs_observationJoin_logged_query_ran_on_2025_04_09_at_10_25_51.sql</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; "&lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span></span></span>
<span><span class="co">#&gt;   my_study_drugs.*,</span></span>
<span><span class="co">#&gt;   observation_period_id,</span></span>
<span><span class="co">#&gt;   observation_period_start_date,</span></span>
<span><span class="co">#&gt;   observation_period_end_date</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> my_study_drugs</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">LEFT JOIN</span> observation_period</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">ON</span> (my_study_drugs.subject_id = observation_period.person_id)" </span></span>
<span><span class="co">#&gt; ```</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ### /tmp/RtmpdAnnWU/sql_folder/CohortConstructor_fulfillCohortReqs_inObservation_logged_query_ran_on_2025_04_09_at_10_25_51.sql</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; "&lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id,</span></span>
<span><span class="co">#&gt;   subject_id,</span></span>
<span><span class="co">#&gt;   cohort_start_date,</span></span>
<span><span class="co">#&gt;   CASE WHEN (observation_period_end_date &gt;= cohort_end_date) THEN cohort_end_date WHEN NOT (observation_period_end_date &gt;= cohort_end_date) THEN observation_period_end_date END<span style="color: #0000BB;"> AS </span>cohort_end_date</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> my_study_drugs</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">WHERE</span></span></span>
<span><span class="co">#&gt;   (cohort_start_date &gt;= observation_period_start_date)<span style="color: #0000BB;"> AND</span></span></span>
<span><span class="co">#&gt;   (cohort_start_date &lt;= observation_period_end_date)" </span></span>
<span><span class="co">#&gt; ```</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ### /tmp/RtmpdAnnWU/sql_folder/CohortConstructor_joinOverlap_workingTbl_logged_query_ran_on_2025_04_09_at_10_25_52.sql</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; "&lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> q01.*, -1.0<span style="color: #0000BB;"> AS </span>date_id</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span> cohort_definition_id, subject_id, cohort_start_date<span style="color: #0000BB;"> AS </span>date</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> my_study_drugs</span></span>
<span><span class="co">#&gt; ) q01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">UNION ALL</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> q01.*, 1.0<span style="color: #0000BB;"> AS </span>date_id</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span> cohort_definition_id, subject_id, cohort_end_date<span style="color: #0000BB;"> AS </span>date</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> my_study_drugs</span></span>
<span><span class="co">#&gt; ) q01" </span></span>
<span><span class="co">#&gt; ```</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ### /tmp/RtmpdAnnWU/sql_folder/CohortConstructor_joinOverlap_ids_logged_query_ran_on_2025_04_09_at_10_25_52.sql</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; "&lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id,</span></span>
<span><span class="co">#&gt;   subject_id,</span></span>
<span><span class="co">#&gt;   SUM(CAST(era_id AS NUMERIC)) OVER (PARTITION BY cohort_definition_id, subject_id ORDER BY date, date_id ROWS UNBOUNDED PRECEDING)<span style="color: #0000BB;"> AS </span>era_id,</span></span>
<span><span class="co">#&gt;   "name",</span></span>
<span><span class="co">#&gt;   date</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span></span></span>
<span><span class="co">#&gt;     my_study_og_006_1744194352.*,</span></span>
<span><span class="co">#&gt;     SUM(date_id) OVER (PARTITION BY cohort_definition_id, subject_id ORDER BY date, date_id ROWS UNBOUNDED PRECEDING)<span style="color: #0000BB;"> AS </span>cum_id,</span></span>
<span><span class="co">#&gt;     CASE WHEN (date_id = -1.0) THEN 'cohort_start_date' WHEN NOT (date_id = -1.0) THEN 'cohort_end_date' END<span style="color: #0000BB;"> AS </span>"name",</span></span>
<span><span class="co">#&gt;     CASE WHEN (date_id = -1.0) THEN 1.0 WHEN NOT (date_id = -1.0) THEN 0.0 END<span style="color: #0000BB;"> AS </span>era_id</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> my_study_og_006_1744194352</span></span>
<span><span class="co">#&gt; ) q01</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">WHERE</span> (cum_id = 0.0 OR (cum_id = -1.0 AND date_id = -1.0))" </span></span>
<span><span class="co">#&gt; ```</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ### /tmp/RtmpdAnnWU/sql_folder/CohortConstructor_joinOverlap_pivot_wider_logged_query_ran_on_2025_04_09_at_10_25_53.sql</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; "&lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id,</span></span>
<span><span class="co">#&gt;   subject_id,</span></span>
<span><span class="co">#&gt;   MAX(CASE WHEN ("name" = 'cohort_end_date') THEN date END)<span style="color: #0000BB;"> AS </span>cohort_end_date,</span></span>
<span><span class="co">#&gt;   MAX(CASE WHEN ("name" = 'cohort_start_date') THEN date END)<span style="color: #0000BB;"> AS </span>cohort_start_date</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> my_study_og_006_1744194352</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">GROUP BY</span> cohort_definition_id, subject_id, era_id" </span></span>
<span><span class="co">#&gt; ```</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ### /tmp/RtmpdAnnWU/sql_folder/CohortConstructor_joinOverlap_relocate_logged_query_ran_on_2025_04_09_at_10_25_53.sql</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; "&lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT DISTINCT</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id,</span></span>
<span><span class="co">#&gt;   subject_id,</span></span>
<span><span class="co">#&gt;   cohort_start_date,</span></span>
<span><span class="co">#&gt;   cohort_end_date</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> my_study_og_006_1744194352" </span></span>
<span><span class="co">#&gt; ```</span></span></code></pre></div>
<p>If we want even more detail, we also have the option to see the
execution plan along with the SQL.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dir_explain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"explain_folder"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir_explain</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">"omopgenerics.log_sql_explain_path"</span> <span class="op">=</span> <span class="va">dir_explain</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">drugs</span> <span class="op">&lt;-</span> <span class="va">cdm</span><span class="op">$</span><span class="va">drugs</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/requireIsFirstEntry.html">requireIsFirstEntry</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">dir_explain</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">file_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">dir_explain</span>, full.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">files</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"### "</span>, <span class="va">file_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"\n\n"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sql_with_quotes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'"'</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">files</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">'\n'</span><span class="op">)</span>, <span class="st">'"'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">sql_with_quotes</span>, <span class="st">"\n```\n\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; ### CohortConstructor_requireIsFirstEntry_min_logged_query_ran_on_2025_04_09_at_10_25_54.sql</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; "&lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> cohort_definition_id, subject_id, cohort_start_date, cohort_end_date</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span></span></span>
<span><span class="co">#&gt;     my_study_drugs.*,</span></span>
<span><span class="co">#&gt;     MIN(cohort_start_date) OVER (PARTITION BY subject_id, cohort_definition_id)<span style="color: #0000BB;"> AS </span>col01</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> my_study_drugs</span></span>
<span><span class="co">#&gt; ) q01</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">WHERE</span> (cohort_start_date = col01)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; &lt;PLAN&gt;</span></span>
<span><span class="co">#&gt; physical_plan</span></span>
<span><span class="co">#&gt; ┌───────────────────────────┐</span></span>
<span><span class="co">#&gt; │         PROJECTION        │</span></span>
<span><span class="co">#&gt; │    ────────────────────   │</span></span>
<span><span class="co">#&gt; │             #0            │</span></span>
<span><span class="co">#&gt; │             #1            │</span></span>
<span><span class="co">#&gt; │             #2            │</span></span>
<span><span class="co">#&gt; │             #3            │</span></span>
<span><span class="co">#&gt; │                           │</span></span>
<span><span class="co">#&gt; │         ~3872 Rows        │</span></span>
<span><span class="co">#&gt; └─────────────┬─────────────┘</span></span>
<span><span class="co">#&gt; ┌─────────────┴─────────────┐</span></span>
<span><span class="co">#&gt; │           FILTER          │</span></span>
<span><span class="co">#&gt; │    ────────────────────   │</span></span>
<span><span class="co">#&gt; │(cohort_start_date = col01)│</span></span>
<span><span class="co">#&gt; │                           │</span></span>
<span><span class="co">#&gt; │         ~3872 Rows        │</span></span>
<span><span class="co">#&gt; └─────────────┬─────────────┘</span></span>
<span><span class="co">#&gt; ┌─────────────┴─────────────┐</span></span>
<span><span class="co">#&gt; │         PROJECTION        │</span></span>
<span><span class="co">#&gt; │    ────────────────────   │</span></span>
<span><span class="co">#&gt; │             #0            │</span></span>
<span><span class="co">#&gt; │             #1            │</span></span>
<span><span class="co">#&gt; │             #2            │</span></span>
<span><span class="co">#&gt; │             #3            │</span></span>
<span><span class="co">#&gt; │             #4            │</span></span>
<span><span class="co">#&gt; │                           │</span></span>
<span><span class="co">#&gt; │        ~19364 Rows        │</span></span>
<span><span class="co">#&gt; └─────────────┬─────────────┘</span></span>
<span><span class="co">#&gt; ┌─────────────┴─────────────┐</span></span>
<span><span class="co">#&gt; │           WINDOW          │</span></span>
<span><span class="co">#&gt; │    ────────────────────   │</span></span>
<span><span class="co">#&gt; │        Projections:       │</span></span>
<span><span class="co">#&gt; │   min(cohort_start_date)  │</span></span>
<span><span class="co">#&gt; │     OVER (PARTITION BY    │</span></span>
<span><span class="co">#&gt; │         subject_id,       │</span></span>
<span><span class="co">#&gt; │    cohort_definition_id)  │</span></span>
<span><span class="co">#&gt; └─────────────┬─────────────┘</span></span>
<span><span class="co">#&gt; ┌─────────────┴─────────────┐</span></span>
<span><span class="co">#&gt; │         SEQ_SCAN          │</span></span>
<span><span class="co">#&gt; │    ────────────────────   │</span></span>
<span><span class="co">#&gt; │   Table: my_study_drugs   │</span></span>
<span><span class="co">#&gt; │   Type: Sequential Scan   │</span></span>
<span><span class="co">#&gt; │                           │</span></span>
<span><span class="co">#&gt; │        Projections:       │</span></span>
<span><span class="co">#&gt; │    cohort_definition_id   │</span></span>
<span><span class="co">#&gt; │         subject_id        │</span></span>
<span><span class="co">#&gt; │     cohort_start_date     │</span></span>
<span><span class="co">#&gt; │      cohort_end_date      │</span></span>
<span><span class="co">#&gt; │                           │</span></span>
<span><span class="co">#&gt; │        ~19364 Rows        │</span></span>
<span><span class="co">#&gt; └───────────────────────────┘" </span></span>
<span><span class="co">#&gt; ```</span></span></code></pre></div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Edward Burn, Marti Catala, Nuria Mercade-Besora, Marta Alcalde-Herraiz, Mike Du, Yuchen Guo, Xihang Chen, Kim Lopez-Guell, Elin Rowlands.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
