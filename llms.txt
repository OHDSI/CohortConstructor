# CohortConstructor

The goal of CohortConstructor is to support the creation and
manipulation of study cohorts in data mapped to the OMOP CDM.

## Tested sources

| Source                      | Driver            | CDM reference                                                                                            | Status                                                                                                                                                                                                              |
|-----------------------------|-------------------|----------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Local R dataframe           | N/A               | [`omopgenerics::cdmFromTables()`](https://darwin-eu.github.io/omopgenerics/reference/cdmFromTables.html) | [![](https://github.com/OHDSI/CohortConstructor/actions/workflows/test-local-omopgenerics.yaml/badge.svg?branch=main)](https://github.com/OHDSI/CohortConstructor/actions/workflows/test-local-omopgenerics.yaml)   |
| In-memory duckdb datatabase | duckdb            | [`CDMConnector::cdmFromCon()`](https://darwin-eu.github.io/CDMConnector/reference/cdmFromCon.html)       | [![](https://github.com/OHDSI/CohortConstructor/actions/workflows/test-duckdb-CDMConnector.yaml/badge.svg?branch=main)](https://github.com/OHDSI/CohortConstructor/actions/workflows/test-duckdb-CDMConnector.yaml) |
| Postgres database           | RPostgres         | [`CDMConnector::cdmFromCon()`](https://darwin-eu.github.io/CDMConnector/reference/cdmFromCon.html)       |                                                                                                                                                                                                                     |
| Postgres database           | DatabaseConnector | [`CDMConnector::cdmFromCon()`](https://darwin-eu.github.io/CDMConnector/reference/cdmFromCon.html)       |                                                                                                                                                                                                                     |
| SQL Server database         | odbc              | [`CDMConnector::cdmFromCon()`](https://darwin-eu.github.io/CDMConnector/reference/cdmFromCon.html)       |                                                                                                                                                                                                                     |
| SQL Server database         | DatabaseConnector | [`CDMConnector::cdmFromCon()`](https://darwin-eu.github.io/CDMConnector/reference/cdmFromCon.html)       |                                                                                                                                                                                                                     |

## Installation

The package can be installed from CRAN:

``` r
install.packages("CohortConstructor")
```

Or you can install the development version of the package from GitHub:

``` r
# install.packages("devtools")
devtools::install_github("ohdsi/CohortConstructor")
```

## Creating and manipulating cohorts

To illustrate the functionality provided by CohortConstructor let’s
create a cohort of people with a fracture using the Eunomia dataset.
We’ll first load required packages and create a cdm reference for the
data.

``` r
library(omopgenerics)
library(omock)
library(PatientProfiles)
library(dplyr)
library(CohortConstructor)
library(CohortCharacteristics)
```

``` r
cdm <- mockCdmFromDataset(datasetName = "GiBleed", source = "duckdb")
#> ℹ Reading GiBleed tables.
#> ℹ Adding drug_strength table.
cdm
#> 
#> ── # OMOP CDM reference (duckdb) of GiBleed ────────────────────────────────────
#> • omop tables: care_site, cdm_source, concept, concept_ancestor, concept_class,
#> concept_relationship, concept_synonym, condition_era, condition_occurrence,
#> cost, death, device_exposure, domain, dose_era, drug_era, drug_exposure,
#> drug_strength, fact_relationship, location, measurement, metadata, note,
#> note_nlp, observation, observation_period, payer_plan_period, person,
#> procedure_occurrence, provider, relationship, source_to_concept_map, specimen,
#> visit_detail, visit_occurrence, vocabulary
#> • cohort tables: -
#> • achilles tables: -
#> • other tables: -
```

### Generating concept-based fracture cohorts

We will first need to identify codes that could be used to represent
fractures of interest. To find these we’ll use the CodelistGenerator
package (note, we will just find a few codes because we are using
synthetic data with a subset of the full vocabularies).

``` r
library(CodelistGenerator)

hip_fx_codes <- getCandidateCodes(cdm, "hip fracture")
#> Limiting to domains of interest
#> Getting concepts to include
#> Adding descendants
#> Search completed. Finishing up.
#> ✔ 1 candidate concept identified
#> 
#> Time taken: 0 minutes and 0 seconds
forearm_fx_codes <- getCandidateCodes(cdm, "forearm fracture")
#> Limiting to domains of interest
#> Getting concepts to include
#> Adding descendants
#> Search completed. Finishing up.
#> ✔ 1 candidate concept identified
#> 
#> Time taken: 0 minutes and 0 seconds

fx_codes <- newCodelist(list("hip_fracture" = hip_fx_codes$concept_id,
                             "forearm_fracture"= forearm_fx_codes$concept_id))
fx_codes
#> 
#> ── 2 codelists ─────────────────────────────────────────────────────────────────
#> 
#> - forearm_fracture (1 codes)
#> - hip_fracture (1 codes)
```

Now we can quickly create our cohorts. For this we only need to provide
the codes we have defined and we will get a cohort back, where we start
by setting cohort exit as the same day as event start (the date of the
fracture).

``` r
cdm$fractures <- cdm |> 
  conceptCohort(conceptSet = fx_codes, 
                exit = "event_start_date", 
                name = "fractures")
#> Warning: There was 1 warning in `dplyr::mutate()`.
#> ℹ In argument: `vocabulary_version = CodelistGenerator::getVocabVersion(cdm)`.
#> Caused by warning:
#> ! The `cdm` argument of `vocabularyVersion()` is deprecated as of
#>   CodelistGenerator 4.0.0.
#> ℹ The deprecated feature was likely used in the CohortConstructor package.
#>   Please report the issue to the authors.
```

After creating our initial cohort we will update it so that exit is set
at up to 180 days after start (so long as individuals’ observation end
date is on or after this - if not, exit will be at observation period
end).

``` r
cdm$fractures <- cdm$fractures |> 
  padCohortEnd(days = 180)
```

We can see that our starting cohorts, before we add any additional
restrictions, have the following associated settings, counts, and
attrition.

``` r
settings(cdm$fractures) |> glimpse()
#> Rows: 2
#> Columns: 4
#> $ cohort_definition_id <int> 1, 2
#> $ cohort_name          <chr> "forearm_fracture", "hip_fracture"
#> $ cdm_version          <chr> "5.3", "5.3"
#> $ vocabulary_version   <chr> "v5.0 18-JAN-19", "v5.0 18-JAN-19"
cohortCount(cdm$fractures) |> glimpse()
#> Rows: 2
#> Columns: 3
#> $ cohort_definition_id <int> 1, 2
#> $ number_records       <int> 569, 138
#> $ number_subjects      <int> 510, 132
attrition(cdm$fractures) |> glimpse()
#> Rows: 14
#> Columns: 7
#> $ cohort_definition_id <int> 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2
#> $ number_records       <int> 569, 569, 569, 569, 569, 569, 569, 138, 138, 138,…
#> $ number_subjects      <int> 510, 510, 510, 510, 510, 510, 510, 132, 132, 132,…
#> $ reason_id            <int> 1, 2, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7
#> $ reason               <chr> "Initial qualifying events", "Record in observati…
#> $ excluded_records     <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
#> $ excluded_subjects    <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
```

### Create an overall fracture cohort

So far we have created three separate fracture cohorts. Let’s say we
also want a cohort of people with any of the fractures. We could union
our three cohorts to create this overall cohort like so:

``` r
cdm$fractures <- unionCohorts(cdm$fractures,
                              cohortName = "any_fracture", 
                              keepOriginalCohorts = TRUE,
                              name ="fractures")
```

``` r
settings(cdm$fractures)
#> # A tibble: 3 × 5
#>   cohort_definition_id cohort_name      cdm_version vocabulary_version   gap
#>                  <int> <chr>            <chr>       <chr>              <dbl>
#> 1                    1 forearm_fracture 5.3         v5.0 18-JAN-19        NA
#> 2                    2 hip_fracture     5.3         v5.0 18-JAN-19        NA
#> 3                    3 any_fracture     <NA>        <NA>                   0
cohortCount(cdm$fractures)
#> # A tibble: 3 × 3
#>   cohort_definition_id number_records number_subjects
#>                  <int>          <int>           <int>
#> 1                    1            569             510
#> 2                    2            138             132
#> 3                    3            707             611
```

### Require in date range

Once we have created our base fracture cohort, we can then start
applying additional cohort requirements. For example, first we can
require that individuals’ cohort start date fall within a certain date
range.

``` r
cdm$fractures <- cdm$fractures |> 
  requireInDateRange(dateRange = as.Date(c("2000-01-01", "2020-01-01")))
```

Now that we’ve applied this date restriction, we can see that our cohort
attributes have been updated

``` r
cohortCount(cdm$fractures) |> glimpse()
#> Rows: 3
#> Columns: 3
#> $ cohort_definition_id <int> 1, 2, 3
#> $ number_records       <int> 152, 62, 214
#> $ number_subjects      <int> 143, 60, 196
attrition(cdm$fractures) |> 
  filter(reason == "cohort_start_date between 2000-01-01 & 2020-01-01") |> 
  glimpse()
#> Rows: 0
#> Columns: 7
#> $ cohort_definition_id <int> 
#> $ number_records       <int> 
#> $ number_subjects      <int> 
#> $ reason_id            <int> 
#> $ reason               <chr> 
#> $ excluded_records     <int> 
#> $ excluded_subjects    <int>
```

### Applying demographic requirements

We can also add restrictions on patient characteristics such as age (on
cohort start date by default) and sex.

``` r
cdm$fractures <- cdm$fractures |> 
  requireDemographics(ageRange = list(c(40, 65)),
                      sex = "Female")
```

Again we can see how many individuals we’ve lost after applying these
criteria.

``` r
attrition(cdm$fractures) |> 
  filter(reason == "Age requirement: 40 to 65") |> 
  glimpse()
#> Rows: 3
#> Columns: 7
#> $ cohort_definition_id <int> 1, 2, 3
#> $ number_records       <int> 64, 22, 86
#> $ number_subjects      <int> 62, 22, 83
#> $ reason_id            <int> 10, 10, 4
#> $ reason               <chr> "Age requirement: 40 to 65", "Age requirement: 40…
#> $ excluded_records     <int> 88, 40, 128
#> $ excluded_subjects    <int> 81, 38, 113

attrition(cdm$fractures) |> 
  filter(reason == "Sex requirement: Female") |> 
  glimpse()
#> Rows: 3
#> Columns: 7
#> $ cohort_definition_id <int> 1, 2, 3
#> $ number_records       <int> 37, 12, 49
#> $ number_subjects      <int> 36, 12, 48
#> $ reason_id            <int> 11, 11, 5
#> $ reason               <chr> "Sex requirement: Female", "Sex requirement: Fema…
#> $ excluded_records     <int> 27, 10, 37
#> $ excluded_subjects    <int> 26, 10, 35
```

### Require presence in another cohort

We can also require that individuals are (or are not) in another cohort
over some window. Here for example we require that study participants
are in a GI bleed cohort any time prior up to their entry in the
fractures cohort.

``` r
cdm$gibleed <- cdm |> 
  conceptCohort(conceptSet = list("gibleed" = 192671L),
  name = "gibleed")

cdm$fractures <- cdm$fractures |> 
  requireCohortIntersect(targetCohortTable = "gibleed",
                         intersections = 0,
                         window = c(-Inf, 0))
```

``` r
attrition(cdm$fractures) |> 
  filter(reason == "Not in cohort gibleed between -Inf & 0 days relative to cohort_start_date") |> 
  glimpse()
#> Rows: 3
#> Columns: 7
#> $ cohort_definition_id <int> 1, 2, 3
#> $ number_records       <int> 30, 10, 40
#> $ number_subjects      <int> 30, 10, 40
#> $ reason_id            <int> 14, 14, 8
#> $ reason               <chr> "Not in cohort gibleed between -Inf & 0 days rela…
#> $ excluded_records     <int> 7, 2, 9
#> $ excluded_subjects    <int> 6, 2, 8
```

``` r
cdmDisconnect(cdm)
```

### More information

CohortConstructor provides much more functionality for creating and
manipulating cohorts. See the package vignettes for more details.

# Package index

### Build base cohorts

- [`conceptCohort()`](https://ohdsi.github.io/CohortConstructor/reference/conceptCohort.md)
  : Create cohorts based on a concept set
- [`deathCohort()`](https://ohdsi.github.io/CohortConstructor/reference/deathCohort.md)
  : Create cohort based on the death table
- [`demographicsCohort()`](https://ohdsi.github.io/CohortConstructor/reference/demographicsCohort.md)
  : Create cohorts based on patient demographics
- [`measurementCohort()`](https://ohdsi.github.io/CohortConstructor/reference/measurementCohort.md)
  : Create measurement-based cohorts

### Apply cohort table related requirements

- [`requireMinCohortCount()`](https://ohdsi.github.io/CohortConstructor/reference/requireMinCohortCount.md)
  : Filter cohorts to keep only records for those with a minimum amount
  of subjects
- [`requireInDateRange()`](https://ohdsi.github.io/CohortConstructor/reference/requireInDateRange.md)
  : Require that an index date is within a date range
- [`requireDuration()`](https://ohdsi.github.io/CohortConstructor/reference/requireDuration.md)
  : Require cohort entries last for a certain number of days
- [`requireIsFirstEntry()`](https://ohdsi.github.io/CohortConstructor/reference/requireIsFirstEntry.md)
  : Restrict cohort to first entry
- [`requireIsLastEntry()`](https://ohdsi.github.io/CohortConstructor/reference/requireIsLastEntry.md)
  : Restrict cohort to last entry per person
- [`requireIsEntry()`](https://ohdsi.github.io/CohortConstructor/reference/requireIsEntry.md)
  : Restrict cohort to specific entry

### Impose singular demographic requirements on existing cohorts

- [`requireAge()`](https://ohdsi.github.io/CohortConstructor/reference/requireAge.md)
  : Restrict cohort on age
- [`requireSex()`](https://ohdsi.github.io/CohortConstructor/reference/requireSex.md)
  : Restrict cohort on sex
- [`requirePriorObservation()`](https://ohdsi.github.io/CohortConstructor/reference/requirePriorObservation.md)
  : Restrict cohort on prior observation
- [`requireFutureObservation()`](https://ohdsi.github.io/CohortConstructor/reference/requireFutureObservation.md)
  : Restrict cohort on future observation

### Impose multiple demographic requirements on existing cohorts

- [`requireDemographics()`](https://ohdsi.github.io/CohortConstructor/reference/requireDemographics.md)
  : Restrict cohort on patient demographics

### Impose requirements of presence or absence in other cohorts, concept sets, or table

- [`requireCohortIntersect()`](https://ohdsi.github.io/CohortConstructor/reference/requireCohortIntersect.md)
  : Require cohort subjects are present (or absence) in another cohort
- [`requireConceptIntersect()`](https://ohdsi.github.io/CohortConstructor/reference/requireConceptIntersect.md)
  : Require cohort subjects to have (or not have) events of a concept
  list
- [`requireTableIntersect()`](https://ohdsi.github.io/CohortConstructor/reference/requireTableIntersect.md)
  : Require cohort subjects are present in another clinical table

### Update cohort start and end dates

- [`entryAtFirstDate()`](https://ohdsi.github.io/CohortConstructor/reference/entryAtFirstDate.md)
  : Update cohort start date to be the first date from of a set of
  column dates
- [`entryAtLastDate()`](https://ohdsi.github.io/CohortConstructor/reference/entryAtLastDate.md)
  : Set cohort start date to the last of a set of column dates
- [`exitAtDeath()`](https://ohdsi.github.io/CohortConstructor/reference/exitAtDeath.md)
  : Set cohort end date to death date
- [`exitAtFirstDate()`](https://ohdsi.github.io/CohortConstructor/reference/exitAtFirstDate.md)
  : Set cohort end date to the first of a set of column dates
- [`exitAtLastDate()`](https://ohdsi.github.io/CohortConstructor/reference/exitAtLastDate.md)
  : Set cohort end date to the last of a set of column dates
- [`exitAtObservationEnd()`](https://ohdsi.github.io/CohortConstructor/reference/exitAtObservationEnd.md)
  : Set cohort end date to end of observation
- [`padCohortDate()`](https://ohdsi.github.io/CohortConstructor/reference/padCohortDate.md)
  : Set cohort start or cohort end
- [`padCohortEnd()`](https://ohdsi.github.io/CohortConstructor/reference/padCohortEnd.md)
  : Add days to cohort end
- [`padCohortStart()`](https://ohdsi.github.io/CohortConstructor/reference/padCohortStart.md)
  : Add days to cohort start
- [`trimDemographics()`](https://ohdsi.github.io/CohortConstructor/reference/trimDemographics.md)
  : Trim cohort on patient demographics
- [`trimDuration()`](https://ohdsi.github.io/CohortConstructor/reference/trimDuration.md)
  : Trim cohort dates to be within a certain interval of days
- [`trimToDateRange()`](https://ohdsi.github.io/CohortConstructor/reference/trimToDateRange.md)
  : Trim cohort dates to be within a date range

### Concatanate cohort entries

- [`collapseCohorts()`](https://ohdsi.github.io/CohortConstructor/reference/collapseCohorts.md)
  : Collapse cohort entries using a certain gap to concatenate records.

### Filter cohorts

- [`subsetCohorts()`](https://ohdsi.github.io/CohortConstructor/reference/subsetCohorts.md)
  : Generate a cohort table keeping a subset of cohorts.
- [`sampleCohorts()`](https://ohdsi.github.io/CohortConstructor/reference/sampleCohorts.md)
  : Sample a cohort table for a given number of individuals.

### Copy cohorts

- [`copyCohorts()`](https://ohdsi.github.io/CohortConstructor/reference/copyCohorts.md)
  : Copy a cohort table

### Split cohorts

- [`yearCohorts()`](https://ohdsi.github.io/CohortConstructor/reference/yearCohorts.md)
  : Generate a new cohort table restricting cohort entries to certain
  years
- [`stratifyCohorts()`](https://ohdsi.github.io/CohortConstructor/reference/stratifyCohorts.md)
  : Create a new cohort table from stratifying an existing one

### Combine cohorts

- [`intersectCohorts()`](https://ohdsi.github.io/CohortConstructor/reference/intersectCohorts.md)
  : Generate a combination cohort set between the intersection of
  different cohorts.
- [`unionCohorts()`](https://ohdsi.github.io/CohortConstructor/reference/unionCohorts.md)
  : Generate cohort from the union of different cohorts

### Match cohorts

- [`matchCohorts()`](https://ohdsi.github.io/CohortConstructor/reference/matchCohorts.md)
  : Generate a new cohort matched cohort

### Mock data

- [`mockCohortConstructor()`](https://ohdsi.github.io/CohortConstructor/reference/mockCohortConstructor.md)
  : Function to create a mock cdm reference for CohortConstructor

### Package benchmark

- [`benchmarkCohortConstructor()`](https://ohdsi.github.io/CohortConstructor/reference/benchmarkCohortConstructor.md)
  : Run benchmark of CohortConstructor package
- [`benchmarkData`](https://ohdsi.github.io/CohortConstructor/reference/benchmarkData.md)
  : Benchmarking results

### Utility functions

- [`renameCohort()`](https://ohdsi.github.io/CohortConstructor/reference/renameCohort.md)
  : Utility function to change the name of a cohort.
- [`addCohortTableIndex()`](https://ohdsi.github.io/CohortConstructor/reference/addCohortTableIndex.md)
  : Add an index to a cohort table

# Articles

### All vignettes

- [Introduction](https://ohdsi.github.io/CohortConstructor/articles/a00_introduction.md):
- [Building base
  cohorts](https://ohdsi.github.io/CohortConstructor/articles/a01_building_base_cohorts.md):
- [Applying cohort table
  requirements](https://ohdsi.github.io/CohortConstructor/articles/a02_cohort_table_requirements.md):
- [Applying demographic requirements to a
  cohort](https://ohdsi.github.io/CohortConstructor/articles/a03_require_demographics.md):
- [Applying requirements related to other cohorts, concept sets, or
  tables](https://ohdsi.github.io/CohortConstructor/articles/a04_require_intersections.md):
- [Updating cohort start and end
  dates](https://ohdsi.github.io/CohortConstructor/articles/a05_update_cohort_start_end.md):
- [Concatenating cohort
  records](https://ohdsi.github.io/CohortConstructor/articles/a06_concatanate_cohorts.md):
- [Filtering
  cohorts](https://ohdsi.github.io/CohortConstructor/articles/a07_filter_cohorts.md):
- [Splitting
  cohorts](https://ohdsi.github.io/CohortConstructor/articles/a08_split_cohorts.md):
- [Combining
  Cohorts](https://ohdsi.github.io/CohortConstructor/articles/a09_combine_cohorts.md):
- [Generating a matched
  cohort](https://ohdsi.github.io/CohortConstructor/articles/a10_match_cohorts.md):
- [CohortConstructor benchmarking
  results](https://ohdsi.github.io/CohortConstructor/articles/a11_benchmark.md):
- [Behind the
  scenes](https://ohdsi.github.io/CohortConstructor/articles/a12_behind_the_scenes.md):
