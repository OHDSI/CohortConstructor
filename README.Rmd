---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# CohortConstructor

<!-- badges: start -->
[![R-CMD-check](https://github.com/oxford-pharmacoepi/CohortConstructor/workflows/R-CMD-check/badge.svg)](https://github.com/oxford-pharmacoepi/CohortConstructor/actions)
[![Lifecycle:Experimental](https://img.shields.io/badge/Lifecycle-Experimental-339999)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![Codecov test coverage](https://codecov.io/gh/OHDSI/CohortConstructor/branch/main/graph/badge.svg)](https://app.codecov.io/gh/OHDSI/CohortConstructor?branch=main)
<!-- badges: end -->

The goal of CohortConstructor is to help on the creation and manipulation of cohorts in the OMOP Common Data Model. The package provides functions to support cohort building pipelines and additional functions to support cohort evaluation.

## Installation

You can install the development version of CohortConstructor from [GitHub](https://github.com/) with:

``` {r, eval = FALSE}
# install.packages("devtools")
devtools::install_github("oxford-pharmacoepi/CohortConstructor")
```

## Creating and manipulating cohorts

``` {r}
library(CDMConnector)
library(PatientProfiles)
library(DrugUtilisation)
library(dplyr)
library(CohortConstructor)

con <- DBI::dbConnect(duckdb::duckdb(), dbdir = eunomia_dir())
cdm <- cdm_from_con(con, cdm_schema = "main", 
                    write_schema = c(prefix = "my_study_", schema = "main"))
```

### Generating concept based cohorts
We'll start by generating a set of drug cohorts, using generateDrugUtilisationCohortSet from the DrugUtilisation R package. Here we make two cohorts, one for diclofenac and another for acetaminophen, combining records with a gap of 7 days or less.
``` {r}
cdm <- generateDrugUtilisationCohortSet(cdm = cdm,  
                            name = "medications",
                            conceptSet = list("diclofenac" = 1124300,
                                           "acetaminophen" = 1127433),
                            gapEra = 7)
```

We can see that our starting cohorts, before we add any additional restrictions, have the following counts
``` {r}
cohort_set(cdm$medications) %>% glimpse()
cohort_count(cdm$medications) %>% glimpse()
```

### Require in date range
We can require that individuals' cohort start date fall within a certain date range.
``` {r}
cdm$medications <- cdm$medications %>% 
  requireInDateRange(indexDate = "cohort_start_date",
                     dateRange = as.Date(c("2000-01-01", "2020-01-01")))
```

Now that we've applied these date restrictions, we can see how many people and records have been excluded
``` {r}
cohort_count(cdm$medications) %>% glimpse()
cohort_attrition(cdm$medications) %>% glimpse()
cohort_attrition(cdm$medications) %>% 
  filter(reason == "cohort_start_date between 2000-01-01 and 2020-01-01") %>% 
  glimpse()
```

### Applying demographic requirements
We can also add restrictions on age (on cohort start date) and sex.
``` {r}
cdm$medications <- cdm$medications %>% 
  requireDemographics(indexDate = "cohort_start_date",
                      ageRange = list(c(40, 65)),
                      sex = "Female")
```

Again we can see how many individuals we've lost after applying this criteria.
``` {r}
cohort_attrition(cdm$medications) %>% 
  filter(reason == "Demographic requirements") %>% 
  glimpse()
```

### Require presence in another cohort
We can also require that individuals are in another cohort over some window. Here for example we require that study participants are in a GI bleed cohort any time prior up to their entry in the medications cohort.
```{r}
cdm <- generate_concept_cohort_set(cdm = cdm, 
                            name = "gibleed",
                            concept_set = list("gibleed" = 192671))

cdm$medications <- cdm$medications %>% 
  requireCohortIntersectFlag(targetCohortTable = "gibleed",
                             window = c(-Inf, 0))
```

``` {r}
cohort_attrition(cdm$medications) %>% 
  filter(reason == "In cohort gibleed between -Inf and 0 days relative to cohort_start_date") %>% 
  glimpse()
```

### Combining cohorts

Currently we have two separate cohorts. One of users of diclofenac, the other of users of acetaminophen. 

Let's say we want to create a cohort of people taking **either** diclofenac or acetaminophen. We could create this cohort like so:
```{r}

```

Alternatively, we might want to create a cohort of people taking **both** diclofenac and acetaminophen. For this we can create this combination cohort like so:

Both diclofenac and acetaminophen

Generate a combination cohort.

```{r}
cdm <- generateIntersectCohortSet(cdm = cdm, 
                                    name = "combinations", 
                                    targetCohortName = "medications")

cohortSet(cdm$combinations)
cohortCount(cdm$combinations)
```

```{r}
cdmDisconnect(cdm)
```


## Evaluating cohorts
