---
title: "a03_age_sex_matching"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{a03_age_sex_matching}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction
CohortConstructor packages includes a function to obtain an age and sex matched cohort, the `generateMatchedCohortSet()` function. In this vignette, we will explore the functionalities of the function and provide valuable examples for its usage.

## Create mock data
We will first use `mockDrugUtilisation()` functin from DrugUtilisation package to create mock data.

```{r, include = FALSE}
library(CohortConstructor)
library(dplyr)
library(DrugUtilisation)

cdm <- mockDrugUtilisation(numberIndividual  = 200)
```

As we will use `cohort1` to explore `generateMatchedCohortSet()`, let us first use `cohort_attrition()` from CDMConnector package to explore the this cohort:

```{r, include = FALSE}
CDMConnector::cohort_set(cdm$cohort1)
```
Notice that there are three cohorts within this tibble, with id's going from 1 to 3. 

# Use `generateMatchedCohortSet()` to create an age-sex matched cohort
Let us first see an example of how this function works. For its usage, we need to provide a `cdm` object, the `targetCohortName`, which is the name of the table containing the cohort of interest, and the `name` of the new table that will be created containing the cohort and the matching cohort. We will also use the argument `targetCohortId` to specify that we only want a matching cohort for `cohort_definition_id = 1`.

```{r, include = FALSE}
cdm <- generateMatchedCohortSet(cdm  = cdm,
                           name = "matched_cohort1",
                           targetCohortName = "cohort1",
                           targetCohortId = 1)

CDMConnector::cohort_set(cdm$matched_cohort1)
```
Notice that in the generated tibble, there are two cohorts: `cohort_definition_id = 1` (original cohort), and `cohort_definition_id = 4` (matched cohort). `target_cohort_name` column indicates which is the original cohort. `match_sex` and `match_year_of_birth` adopt boolean values (`TRUE`/`FALSE`) indicating if we have matched for sex and age, or not. `match_status` indicate if it is the original cohort (`target`) or if it is the matched cohort (`matched`). `target_cohort_id` indicates which is the cohort_id of the original cohort.

`matchSex` is a boolean parameter (`TRUE`/`FALSE`) indicating if we want to match by sex (`TRUE`) or we do not want (`FALSE`).

`matchYear` is another boolean parameter (`TRUE`/`FALSE`) indicating if we want to match by age (`TRUE`) or we do not want (`FALSE`).

The default matching ratio is 1:1. Use `cohort_counts()` from CDMConnector to check if the matching has been done as desired.

```{r, include = FALSE}
CDMConnector::cohort_count(cdm$matched_cohort1)
```
To have more information about the exclusion criteria applied to perform the matching, use `cohort_attrition()` from CDMConnector package:
```{r, include = FALSE}
# Original cohort
CDMConnector::cohort_attrition(cdm$matched_cohort1) %>% filter(cohort_definition_id == 1)

# Matched cohort
CDMConnector::cohort_attrition(cdm$matched_cohort1) %>% filter(cohort_definition_id == 4)
```
Briefly, from the original cohort, we exclude first those individuals that do not have a match, and then individuals that their matching pair is not in observation during the assigned `cohort_start_date`. From the matched cohort, we start from the whole database and we first exclude individuals that are in the original cohort. Afterwards, we exclude individuals that do not have a match, then individuals that are not in observation during the assigned `cohort_start_date`, and finally we remove the as many individuals as required to fulfill the ratio.

You can modify the `ratio` parameter to tailor your matched cohort.

```{r, include = FALSE}
cdm <- generateMatchedCohortSet(cdm  = cdm,
                           name = "matched_cohort1",
                           targetCohortName = "cohort1",
                           targetCohortId = 1,
                           ratio = Inf)

CDMConnector::cohort_count(cdm$matched_cohort1)
```

