---
title: "Presence and Absence Requirements"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{a04_require_intersections}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(CohortConstructor)
library(CohortCharacteristics)
library(ggplot2)
```

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  eval = TRUE, message = FALSE, warning = FALSE,
  comment = "#>"
)

library(CDMConnector)
library(dplyr, warn.conflicts = FALSE)

if (Sys.getenv("EUNOMIA_DATA_FOLDER") == ""){
  Sys.setenv("EUNOMIA_DATA_FOLDER" = file.path(tempdir(), "eunomia"))}
if (!dir.exists(Sys.getenv("EUNOMIA_DATA_FOLDER"))){ dir.create(Sys.getenv("EUNOMIA_DATA_FOLDER"))
  downloadEunomiaData()  
}
```

For this example we'll use the Eunomia synthetic data from the CDMConnector package.

```{r}
con <- DBI::dbConnect(duckdb::duckdb(), dbdir = eunomia_dir())
cdm <- cdm_from_con(con, cdm_schema = "main", 
                    write_schema = c(prefix = "my_study_", schema = "main"))
```

Let's start by creating two drug cohorts, one for users of diclofenac and another for users of acetaminophen.

```{r}
cdm$medications <- conceptCohort(cdm = cdm, 
                                 conceptSet = list("diclofenac" = 1124300,
                                                   "acetaminophen" = 1127433), 
                                 name = "medications")

settings(cdm$medications)
cohortCount(cdm$medications)
```

As well as our medication cohorts, let's also make another cohort containing individuals with a record of a cystitis. Later we'll use this cohort when specifying inclusion/ exclusion criteria.

```{r}
cdm$cystitis <- conceptCohort(cdm = cdm,  
                              conceptSet = list("cystitis" = 195588),
                              name = "cystitis")

settings(cdm$cystitis)
cohortCount(cdm$cystitis)
```

## Restrictions on cohort presence

We could require that individuals in our medication cohorts have a history of cystitis. To do this we can use the `requireCohortIntersect()` function, requiring that individuals have one or more intersections with the cystitis cohort.

```{r}
cdm$medications_cystitis <- cdm$medications  %>%
  requireCohortIntersect(intersections = c(1,3),
                         targetCohortTable = "cystitis", 
                         targetCohortId = 1,
                         indexDate = "cohort_start_date", 
                         window = c(-365, 0), 
                         name = "medications_cystitis")

summary_attrition <- summariseCohortAttrition(cdm$medications_cystitis)
plotCohortAttrition(summary_attrition, cohortId = 1)
```

The flow chart above illustrates the changes to cohort 1 (users of acetaminophen) when restricted to only include individuals that intersect with the cystitis cohort at least once. 

Instead of requiring that individuals have history of cystitis, we could instead require that they are don't have any history of it. In this case we can again use the `requireCohortIntersect()` function, but this time set the intersections argument to 0 to require individuals' absence in this other cohort rather than their presence in it.

```{r}
cdm$medications_no_cystitis <- cdm$medications %>%
  requireCohortIntersect(intersections = 0,
                         targetCohortTable = "cystitis", 
                         targetCohortId = 1,
                         indexDate = "cohort_start_date", 
                         window = c(-365, 0), 
                         name = "medications_no_cystitis") 

summary_attrition <- summariseCohortAttrition(cdm$medications_no_cystitis)
plotCohortAttrition(summary_attrition, cohortId = 1)
```

The flow chart above illustrates the changes to cohort 1 when restricted to only include individuals that have no intersections with the cystitis cohort. 

## Restrictions on cohort concepts

Another way of ensuring the individuals in our medication cohorts have a history of cystitis is to use the `requireCohortIntersect()` function. This filters a cohort requiring that individuals are seen (or not seen) to have events related to a specific concept.


```{r, include = FALSE}
cdm <- cdm_from_con(con, cdm_schema = "main", 
                    write_schema = c(prefix = "my_study_", schema = "main"))

cdm$medications <- conceptCohort(cdm = cdm, 
                                 conceptSet = list("diclofenac" = 1124300,
                                                   "acetaminophen" = 1127433), 
                                 name = "medications")
```

```{r}
cdm$medications_cystitis <-  requireConceptIntersect(
  cohort = cdm$medications,
  conceptSet = list("cystitis" = 195588),
  window = c(-365, 0),
  name = "medications_cystitis")

summary_attrition <- summariseCohortAttrition(cdm$medications_cystitis)
plotCohortAttrition(summary_attrition, cohortId = 1)
```

The flow chart above illustrates the changes to cohort 1 when restricted to only include individuals that are seen to have events related to cystitis in the 365 days leading up to the cohort start date.

```{r}
cdm$medications_no_cystitis <-  requireConceptIntersect(
  cohort = cdm$medications,
  conceptSet = list("cystitis" = 195588),
  window = c(-365, 0),
  name = "medications_no_cystitis",
  intersections = 0)

summary_attrition <- summariseCohortAttrition(cdm$medications_no_cystitis)
plotCohortAttrition(summary_attrition, cohortId = 1)
```

The flow chart above illustrates the changes to cohort 1 when restricted to only include individuals that are not seen to have events related to cystitis in the 365 days leading up to the cohort start date.


## Restrictions on clinical tables

It is also possible to use the `requireTableIntersect()` function to filter a cohort include or exclude individuals with a history of cystitis. It filters a cohort based on whether an individual is seen (or not seen) to have a record in a clinical table.

```{r, include = FALSE}
cdm <- cdm_from_con(con, cdm_schema = "main", 
                    write_schema = c(prefix = "my_study_", schema = "main"))

cdm$medications <- conceptCohort(cdm = cdm, 
                                 conceptSet = list("diclofenac" = 1124300,
                                                   "acetaminophen" = 1127433), 
                                 name = "medications")

cdm$cystitis <- conceptCohort(cdm = cdm,  
                              conceptSet = list("cystitis" = 195588),
                              name = "cystitis")
```

```{r}
cdm$medications_cystitis <- requireTableIntersect(
                        cohort = cdm$medications,
                        tableName = "cystitis",
                        indexDate = "cohort_start_date",
                        window = c(-365, 0),
                        name = "medications_cystitis")

summary_attrition <- summariseCohortAttrition(cdm$medications_cystitis)
plotCohortAttrition(summary_attrition, cohortId = 1)
```

The flow chart above illustrates the changes to cohort 1 when restricted to only include individuals that are seen to have a record in the cystitis table in the 365 days leading up to the cohort start date.

```{r}
cdm$medications_no_cystitis <- requireTableIntersect(
                        cohort = cdm$medications,
                        tableName = "cystitis",
                        indexDate = "cohort_start_date",
                        window = c(-365, 0),
                        name = "medications_no_cystitis",
                        intersections = 0)

summary_attrition <- summariseCohortAttrition(cdm$medications_no_cystitis)
plotCohortAttrition(summary_attrition, cohortId = 1)
```

The flow chart above illustrates the changes to cohort 1 when restricted to only include individuals that are not seen to have a record in the cystitis table in the 365 days leading up to the cohort start date.

## Restrictions on death records

We can also restrict our cohort to include individuals who seen (or not seen) to have a death by using the `requireDeathFlag()` function.

```{r, include = FALSE}
cdm <- cdm_from_con(con, cdm_schema = "main", 
                    write_schema = c(prefix = "my_study_", schema = "main"))

cdm$medications <- conceptCohort(cdm = cdm, 
                                 conceptSet = list("diclofenac" = 1124300,
                                                   "acetaminophen" = 1127433), 
                                 name = "medications")

cdm$cystitis <- conceptCohort(cdm = cdm,  
                              conceptSet = list("cystitis" = 195588),
                              name = "cystitis")
```

```{r}
cdm$medications_deaths <- requireDeathFlag(
                        cohort = cdm$medications,
                        window = list(c(0,Inf)),
                        name = "medications_deaths",
                        negate = TRUE)

summary_attrition <- summariseCohortAttrition(cdm$medications_deaths)
plotCohortAttrition(summary_attrition, cohortId = 1)
```

The flow chart above illustrates the changes to cohort 1 when restricted to only include individuals that are seen to have a death on or after the cohort start date.
